*****************************************************************
Настройка обмена данными с системой МойСклад в формате CommerceML
*****************************************************************

Инструкция по настройке обмена данными системы МойСклад в формате CommerceML с интернет-магазином на платформе CS-Cart.

.. contents:: Содержание
    :local: 
    :depth: 3


Настройки в системе МойСклад
----------------------------

Для начала работы зарегистрируйтесь в системе МойСклад.

Официальный сайт:  |link|

.. |link| raw:: html

   <!--noindex--><a href="https://online.moysklad.ru" target="_blank" rel="nofollow">moysklad.ru</a><!--/noindex-->

.. fancybox:: img/moy_sklad_01.png
    :alt: Обмен данными МойСклад

Настройте обмен с интернет-магазином
====================================

Сначала нужно настроить обмен в системе "МойСклад".

1.  В системе "МойСклад" зайдите в "Обмен данными" - "Синхронизация".

    .. fancybox:: img/moy_sklad_02.png
        :alt: Обмен данными МойСклад

2.  В окне синхронизации добавьте новый магазин "Обмен по CommerceML".

    .. fancybox:: img/moy_sklad_03.png
        :alt: Обмен данными МойСклад

3.  В окне "Обмен по CommerceML" заполните поля:

    *   Адрес магазина - адрес скрипта, который будет обрабатывать выгружаемые файлы (например, http://my_site.ru/exim_1c)
    
        .. hint:: Если проверка соединения не сработала с http-адресом, попробуйте https: https://my_site.ru/exim_1c.

    *   Логин - логин администратора магазина, у которого установлены права для обмена

    *   Пароль - пароль администратора магазина

    *   Заказы - настройки для загрузки заказов

    *   Остатки - настройки выгрузки товаров

    .. fancybox:: img/moy_sklad_04.png
        :alt: Обмен данными МойСклад

Настройки в интернет-магазине
-----------------------------

Для обмена данными "МойСклад" с интернет-магазином установите модуль "Экспорт, импорт 1С" (:doc:`см. "Установка модулей" <../../1manage_addons>`). 

.. note:: 

    Панель администратора → Верхнее меню → Модули → Управление модулями → "Экспорт и импорт в 1С"

.. fancybox:: img/moy_sklad_05.png
    :alt: Обмен данными МойСклад

После установки модуля откройте его настройки. 

Окно "Настройки модуля" содержит вкладки:

*   Общие настройки

*   Настройки свойств

*   Настройки опций

*   Настройки цен

*   Параметры доставки

*   Настройки заказов


.. fancybox:: img/moy_sklad_06.png
    :alt: Обмен данными МойСклад
   
Выбор версии схемы
==================

В настройках модуля "Экспорт  и импорт в 1С" есть настройка выбора схемы, которая определяет формат загрузки характеристик(опций) товара.
Для определения версии схемы, необходимо:

1. Нажать в окне "Обмен по CommerceML" у "Остатки" на ссылку "Выгрузить сейчас".

    .. fancybox:: img/moy_sklad_07.png
        :alt: Обмен данными МойСклад

2. Открыть выгруженные файлы import.xml и offers.xml в магазине (меню "Администрирование" - "Файлы"). В файлах осуществить поиск тега ``<ХарактеристикиТовара>``.

    .. fancybox:: img/moy_sklad_08.png
        :alt: Обмен данными МойСклад

3. Если тег ``<ХарактеристикиТовара>`` нашелся в файле import или в обоих файлах, то необходимо выбрать версию схемы 2.07.
   Если тег нашелся только в файле offers, то выбрать версию схемы 2.05.


Общие настройки
===============

Вкладка "Общие настройки" содержит следующие поля:

.. fancybox:: img/moy_sklad_09.png
    :alt: Обмен данными МойСклад

.. list-table::
    :widths: 15 30

    *   -   Версия схемы

        -   В зависимости от формата передаваемых данных, необходимо выбрать соответствующую версию схемы:

            *   2.05 - выберите, если характеристики товара выгружаются только в файл offers. Выгрузка вариаций товаров из "МойСклад" в CS-Cart работает только со схемой 2.05.

            *   2.07 - выберите, если характеристики товара выгружаются в файл import.

    *   -   Язык по умолчанию

        -   Настройка определяющая какой язык будет использоваться для записи данных.

    *   -   Значение для связывания категорий

        -   Поле, по которому будет выполнятся связывание категорий

    *   -   Значение для связывания товаров

        -   Поле, по которому будет выполнятся связывание товаров

    *   -   Загружать товары

        -   Параметр определяющий какие товары будут загружаться в магазин:

            *   Все товары

            *   Новые товары

            *   Новые товары и все цены товаров

            *   Только обновление товаров

            *   Не загружать

    *   -   Разрешить импорт категорий

        -   Параметр, определяющий будут ли загружаться группы из "МойСклад".  Если данная настройка отключена, то товары будут записаны в категорию, указанную в настройке "Категория по умолчанию".

    *   -   Категория по умолчанию

        -   Категория в которую будут добавлены новые товары из "МойСклад", если настройка "Разрешить импорт категорий" выключена.

    *   -   Скрывать товары, которых нет в наличии

        -   Автоматически присваивает товарам статус "Скрыто", если количество товара равно 0.

    *   -   Добавлять налог к товарам.

        -   Товарам будут добавлены налоги, используемые в "МойСклад". 

            Настройки выгрузки налогов доступны на странице "Модули → Настройки CommerceML → Соответствие налогов".

            Для настройки выгрузки налогов необходимо указать соответствия налогов в CS-Cart и процентной ставкой в "МойСклад".

    *   -   Импортировать изображения как дополнительные

        -   Все изображения товара будут загружены как дополнительные.

    *   -   Использовать в названии товара

        -   Параметр, определяющий какие данные будут записываться в наименование товара:

            *   Рабочее наименование 

            *   Наименование для печати

    *   -   Использовать в артикуле товара

        -   Определяет какие данные будут записываться в поле артикула товара:

            *   Артикул

            *   Код номенклатуры

            *   Штрихкод

    *   -   Использовать в полном описании товара

        -   Определяет какие данные будут записываться в качестве полного описания товара:

            *   Текстовое описание

            *   Файл описания для сайта

            *   Наименование для печати

    *   -   Использовать в кратком описании товара

        -   Определяет какие данные будут записываться в качестве краткого описания товара:

            *   Текстовое описание

            *   Файл описания для сайта

            *   Наименование для печати

    *   -   Использовать в название страницы (SEO)

        -   Параметр, определяющий какие данные будут записываться в поле название страницы:

            *   Наименование

            *   Полное наименование


Настройка свойств
=================
        
Вкладка "Настройка свойств" содержит следующие настройки:

.. fancybox:: img/moy_sklad_11.png
    :alt: Обмен данными МойСклад

.. list-table::
    :widths: 15 30

    *   -   Разрешить импорт свойств

        -   Свойства из "МойСклад" будут загружены в магазин.

    *   -   Название свойства для промо-текста

        -   В качестве промо-текста для товара будет загружено значение указанного свойства из "МойСклад".

    *   -   Значение, используемое в качестве бренда

        -   Параметр, определяющий, будет ли использоваться бренд:

            *   Не использовать

            *   Значение изготовителя

            *   Свойство товара

    *   -   Название свойства для бренда

        -   В качестве бренда будет загружено указанное свойство из "МойСклад".

    *   -   Настройка запрета/разрешения выгрузки свойств

        -   Выбор метода исключения для загружаемых свойств:

            *   Не использовать функцию запрета/разрешения выгрузки свойств

            *   Загружать только

            *   Не загружать

    *   -   Список свойств для запрета/разрешения выгрузки

        -   Список свойств для разрешения или запрета загрузки. Каждое свойство необходимо вводить с новой строки.


Настройка опций
===============
        
Вкладка "Настройка опций" содержит следующие настройки:

.. fancybox:: img/commerceml_option_settings.png
    :alt: Обмен данными МойСклад

.. list-table::
    :widths: 15 30

    *   -   Тип опций

        -   Тип для отображения опций товара загруженных из "МойСклад":

            *   Список вариантов

            *   Радиогруппа

    *   -   Способы загрузки опций.

        -   Способ загрузки опций товара из "МойСклад":

            *   "Вариации (рекомендуемое значение)" — оптимальный вариант для импорта товаров с опциями, у которых есть модификаторы цены. Необходим :doc:`модуль "Вариации товаров" </user_guide/addons/product_variations/index>` и использование схемы версии 2.05.

            *   "Комбинация из одной опции (цена в модификаторах)" — на стороне CS-Cart будет создана одна опция с несколькими вариантами вида *"Размер: 12, Цвет: Белый"*. Название опции берется из настройки ниже. Цена самого товара будет равна нулю, а стоимость будет задана в модификаторах вариантов опции.

            *   "Комбинация из одной опции (общая цена)" — на стороне CS-Cart будет создана одна опция с несколькими вариантами. Цена товара берётся из последней импортируемой комбинации. *Этот способ появился в CS-Cart 4.7.3.*

            *   "Комбинация из опций (цена не импортируется)" — на стороне CS-Cart будут созданы отдельные опции (например, *"Размер: 12"* и *"Цвет: Белый"*), и на их основе будут созданы комбинации. Цена у комбинаций и товара не обновляется. *Этот способ появился в CS-Cart 4.7.3.*

            *   "Комбинация из опций без модификаторов (одинаковая цена)" — на стороне CS-Cart будут созданы отдельные опции, и на их основе сбудут созданы комбинации. Модификаторов цены у вариантов опций не будет. Цена товара берется из последней импортируемой комбинации.

            *   "Комбинация из глобальных опций (цена не импортируется)" — на стороне CS-Cart будут созданы глобальные опции, и на их основе будут созданы комбинации. Цена у комбинаций и товара не обновляется.

    *   -   Название опции

        -   Название опции используемое для комбинаций характеристик номенклатуры загружаемой из "МойСклад", при выборе в настройке "Способ загрузки опций" значения "Комбинация из одной опции (цена в модификаторах)".


Настройки цен
=============
        
Вкладка "Настройки цен" содержит настройки загрузки цен:

.. fancybox:: img/moy_sklad_13.png
    :alt: Обмен данными МойСклад

Если настройка **Импортировать количество и цены** включена, то в магазин будут загружаться цены и количество товаров.
   
Выберите настройку **Загружать несколько цен** для загрузки нескольких цен (Базовая цена, Рекомендованная цена, Оптовые цены). 

Загрузка нескольких цен реализована с помощью цен для групп пользователей. Вы можете задать для каждой группы пользователей (Опт, Розница, Золотой клиент) свою цену на товар.

Для настройки выгрузки цен и соответствия цен группам пользователей в CS-Cart перейдите на страницу "Модули → Настройки CommerceML → Соответствие цен".

Если существует необходимость выгрузки нескольких видов цен в одну цену, то их можно добавить в настройках через запятую.

Страница "Соответствие цен" содержит поля:

*   "Базовая цена" - это цена товара по умолчанию для всех групп пользователей; 

*   "Рекомендованная цена" - это рекомендованная цена товара в разделе "Ценообразование/наличие";

*   "Цена в магазине" - это цена, которая будет доступна для указанной группы пользователей.
    
.. fancybox:: img/moy_sklad_14.png
    :alt: Обмен данными МойСклад

Для проверки введенных названий цен (соглашений) в модуле предусмотрено тестирование выгружаемых цен. Для тестирования:

1.  Установите галочку "Запустить режим отладки цен" в настройках модуля.

2.  В "МойСклад" у "Остатки" нажмите на ссылку "Выгрузить сейчас".

3.  Далее перейдите на страницу "Соответствие цен" в панели администратора и посмотрите результат.

4.  Для полноценной выгрузки уберите галочку "Запустить режим отладки цен" в настройках модуля "Экспорт и импорт в 1С" и повторите выгрузку.


Параметры доставки
==================
    
Вкладка "Параметры доставки" настраивает загрузку дополнительных реквизитов номенклатуры (в одном поле можно указать несколько реквизитов для каждого вида номенклатуры с новой строки) и содержит следующие настройки:
    
.. fancybox:: img/moy_sklad_15.png
    :alt: Обмен данными МойСклад

.. list-table::
    :widths: 15 30

    *   -   Наименование свойства для веса

        -   Выгружаемый дополнительный реквизит номенклатуры.

    *   -   Отображать вес, как характеристику

        -   По весу товара будет создана характеристика, для фильтра товаров по характеристикам.

    *   -   Наименование свойства для бесплатной доставки

        -   Выгружаемый дополнительный реквизит номенклатуры.

    *   -   Отображать бесплатную доставку как характеристику

        -   По параметру "Бесплатная доставка товара" будет создана характеристика товара.

    *   -   Стоимость доставки

        -   Дополнительный реквизит номенклатуры.

    *   -   Количество штук в коробке

        -   Дополнительный реквизит номенклатуры.

    *   -   Длина коробки

        -   Дополнительный реквизит номенклатуры.

    *   -   Ширина коробки

        -   Дополнительный реквизит номенклатуры.

    *   -   Высота коробки

        -   Дополнительный реквизит номенклатуры.

Настройки заказов
=================
    
Вкладка "Настройки заказов" содержит следующие поля:

.. fancybox:: img/moy_sklad_16.png
    :alt: Обмен данными МойСклад

.. list-table::
    :widths: 15 30
    
    *   -   Включать отдельно стоимость доставки заказа
    
        -   Доставка будет выгружена в виде отдельной номенклатуры.

    *   -   Выгружать опции товара
    
        -   В заказах товары, имеющие опции, будут выгружаться с опциями. Будут загружатся только те опции, которые изначально были созданы в системе учёта; опции созданные в магазине загружатся не будут.

    *   -   Выгружать с номера
    
        -   Для загрузки будут доступны заказы, начиная с указанного номера.

    *   -   Загружать статусы заказов
    
        -   В магазин будут загружены статусы для соответствующих заказов, выгруженные в файл orders.

    *   -   Выгружать статусы заказов
    
        -   Из магазина будут выгружены заказы со статусами.

    *   -   Выгрузить все товары магазина

        -   Заказы из магазина выгружаться не будут. Вместо этого будут выгружены все включенные товары, у которых включена настройка "Обновлять товар".

    *   -   Статусы выгружаемых заказов
    
        -   Статусы заказов, которые будут выгружены.


Обмен данными между МойСклад и CS-Cart
--------------------------------------

Обмен данными между МойСклад и CS-Cart можно осуществлять одним из способов:

*   Автоматический запуск

    Для автоматического запуска обмена необходимо в настройках синхронизации "МойСклад" включить настройку "Выгружать каждые", "Загружать каждые" и указать время.

*   Ручной запуск

    Для запуска обмена данными в настройках синхронизации "МойСклад" нажмите на ссылку "Выгрузить сейчас" и "Загрузить сейчас".

.. fancybox:: img/moy_sklad_17.png
    :alt: Обмен данными МойСклад

Для просмотра событий выгрузки данных в окне "Обмен по CommerceML" перейдите во вкладку "Отчет".
    
.. fancybox:: img/moy_sklad_18.png
    :alt: Обмен данными МойСклад
