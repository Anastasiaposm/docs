***************************************************
Обмен данными между интернет-магазином и 1С УТ 11.1
***************************************************

.. important::

    У 1С много разных версий и конфигураций, которые могут выглядеть по-разному. Поэтому мы на примере пары конкретных версий описываем общий принцип настройки, чтобы вы по аналогии могли настроить свою версию 1C. Если там нет какого-то элемента управления или сильно отличается внешний вид, рекомендуем обратиться в техподдержку 1С.

Инструкция по настройке обмена данными между 1С и интернет-магазином на платформе CS-Cart.

.. contents:: Содержание
    :local: 
    :depth: 3


Настройки в 1С
--------------

Запустите файл "1сv8.exe". В открывшемся окне выберите базу данных, с которой будет производиться обмен, и нажмите на кнопку "1С: Предприятие".

.. fancybox:: img/1Cimage_1.png
    :alt: Обмен данными 1C и CS-Cart

После запуска необходимо выбрать пользователя и ввести пароль (если у пользователя задан пароль).

.. fancybox:: img/1Cimage_2.png
    :alt: Обмен данными 1C и CS-Cart

Если пользователь и пароль введены правильно, откроется окно "Демонстрационная база".

.. fancybox:: img/1Cimage_3.png
    :alt: Обмен данными 1C и CS-Cart

Настройте обмен с интернет-магазином
====================================

Сначала нужно настроить обмен с интернет-магазином.

#. В программе 1С: Предприятие зайдите в "Администрирование" и нажмите на ссылку "Настройки синхронизации данных". В окне "Настройки синхронизации данных" включите "Обмен данными с сайтами".

   .. fancybox:: img/1Cimage_4.png
       :alt: Обмен данными 1C и CS-Cart

#. Нажмите на ссылку "Общие настройки" и включите "Дополнительные реквизиты и сведения"

   .. fancybox:: img/1Cimage_5.png
       :alt: Обмен данными 1C и CS-Cart

#. Нажмите на ссылку "CRM и продажи" в левом меню и включите "Заказы клиентов" в появившейся форме.

   .. fancybox:: img/1Cimage_6.png
       :alt: Обмен данными 1C и CS-Cart


Создайте типовое соглашение с клиентами
=======================================

После необходимой настройки обмена создайте типовое соглашение с клиентами. Lля этого пройдите в раздел "Маркетинг и планирование" и нажмите на ссылку "Типовые соглашения с клиентами".

#. В окне "Типовые соглашения об условиях продаж" нажмите на кнопку "Создать".

   .. fancybox:: img/1Cimage_7.png
       :alt: Обмен данными 1C и CS-Cart

#. В новом окне "Типовое соглашение об условиях продаж" заполните все неоходимые поля, при этом:

   * поле "Статус" должно иметь значение "Действует";

   * поле "Сегмент партнеров" должно быть пустым;

   * поле "Доступно внешним пользователем" должно быть отмечено галочкой.

     .. fancybox:: img/1Cimage_8.png
         :alt: Обмен данными 1C и CS-Cart

#. Создайте новый узел обмена. Для этого пройдите в "Администрирование" и нажмите на ссылку "Настройки синхронизации данных". В окне "Настройки синхронизации данных" нажмите на ссылку "Узлы обмена с сайтами" и создайте новый узел.

    .. fancybox:: img/1Cimage_9.png
        :alt: Обмен данными 1C и CS-Cart

#. В окне создания нового узла необходимо настроить процесс обмена.

   .. fancybox:: img/1Cimage_10.png
       :alt: Обмен данными 1C и CS-Cart

Настройка процесса обмена (узел обмена)
=======================================

Вкладка "Основные настройки"
****************************

Во вкладке "Основные настройки" узла обмена заполните следующие поля:

.. list-table::
    :widths: 10 30

    *   -   Наименование

        -   Введите наименование обмена

    *   -   "Режим обмена данными"

        -   *   "Выгрузка товаров", если планируется выгрузка товаров на сайт;

            *   "Обмен заказами", если планируется загрузка и выгрузка заказов.

    *   -   Выберите назначение обмена

        -   *   "Выгружать на сайт" — для выгрузки данных на сайт.

                Если выбрано данное назначение, то в поле "Адрес сайта" введите путь к скрипту, который будет обрабатывать обмен (например, http://my_site.ru/exim_1c).

                    .. important::

                        Также необходимо ввести имя пользователя интернет-магазина и его пароль.

                Для проверки соединения нажмите кнопку "Проверить соединение". Если все параметры заполнены корректно, появится сообщение "Соединение успешно установлено". В противном случае проверьте правильность введенного адреса и параметров доступа.

                    .. important::

                        Если проверка соединения проходит неудачно, обмен работать не будет.

                В процессе обмена товарам, загруженным из 1С в поле "Магазин", будет записано название магазина, имя и пароль администратора которого указано в настройках узла обмена в 1С.

            *   "Выгружать в каталог на диске" — для выгрузки данных в файл. 

                Если выбрано данное назначение, то необходимо указать путь к каталогу, куда будут выгружаться данные.

    *   -   Выберите контроль изменений:

        -   *   "Полная выгрузка" — выгрузка всех товаров и заказов, соответствующих условиям выгрузки.

            *   "Выгружать только измененные объекты" — выгрузка объектов, измененных с момента последней удачной выгрузки.

    *   -   "Использовать периодический обмен данными"

        -   Для автоматического обмена данными включите "Использовать периодический обмен данными" и настройте расписание обмена, чтобы обмен запускался автоматически когда это необходимо.

            .. fancybox:: img/1Cimage_11.png
                :alt: Обмен данными 1C и CS-Cart

Вкладка "Выгрузка товаров"
**************************

Во вкладке "Выгрузка товаров" заполните поля (вкладка доступна и видна, если включен флажок "Выгрузка товаров" на вкладке "Основные настройки"):

.. fancybox:: img/1Cimage_12.png
   :alt: Обмен данными 1C и CS-Cart

.. list-table::
    :widths: 15 30

    *   -   Организацию-владельца каталога товаров

        -   Это организация, от имени которой будет производиться обмен.

    *   -   Выгружаемые данные

        -   *   Каталог товаров.

            *   Файлы изображений — будут выгружаться изображения товаров.

            *   Прочие файлы — будут выгружаться присоединенные файлы товаров.

            *   Классифицировать по видам номенклатуры — категории товаров будут выгружаться из справочника "Виды номенклатуры", если настройка выключена категории будут выгружаться из справочника "Номенклатура".

            *   Цены по соглашениям и остатки товаров на складах.

            *   Склады доступные для выбора на сайте.

    *   -   Таблица каталогов

        -   В данной таблице можно указать отбор данных выгружаемых на сайт.

**Настройки "Таблицы каталогов"**

*   В колонке "Каталог" задается имя каталога, 

*   В колонке "Группы номенклатуры" настраивается фильтр выгрузки групп (состав выбираемых групп зависит от установки флажка "Классифицировать по видам номенклатуры"): 

    -   Если флажок "Классифицировать по видам номенклатуры" включен, то группы выбираются из справочника "Виды номенклатуры", иначе — из справочника "Номенклатура".

    -   Если группы не выбраны, то выгружаться будут все группы. В колонке "Идентификатор каталога" задается идентификатор, по которому устанавливается связь выгружаемых данных с конкретными категориями в интернет магазине.

*   Для настройки отбора выберите колонку "Отбор" в таблице каталогов. В форме настройки отбора установите ограничения по выгрузке товаров. 

.. fancybox:: img/1Cimage_13.png
    :alt: Обмен данными 1C и CS-Cart


Вкладка "Обмен заказами"
************************

Вкладка "Обмен заказами" (вкладка доступна и видна, если включен флажок "Обмен заказами" на вкладке "Основные настройки") содержит два раздела "Параметры обмена заказами" и "Дополнительно".

В разделе **"Основные настройки обмена заказами"** заполните следующие поля:

.. fancybox:: img/1Cimage_14.png
   :alt: Обмен данными 1C и CS-Cart

*   Заполните поля "Дата заказа на сайте" и "Номер заказа на сайте", по которым будет осуществляться поиск заказов с сайта.

    .. important::

        Для добавления значений, используемых в полях "Дата заказа на сайте" и "Номер заказа на сайте", откройте "Общие настройки". В окне общих настроек нажмите на ссылку "Дополнительные реквизиты". В окне дополнительные реквизиты в левом окне выберите "Заказ клиента" и добавьте дополнительные реквизиты.

*   В поле "Соглашение" выберите ранее созданное типовое соглашение с клиентами.

*   В поле "Организация" выберите организацию, от имени которой будет создаваться документ "Заказ клиента".

*   В поле "Склад" укажите склад, который будет использоваться в документе "Заказ клиента".

*   Заполните поле "Менеджер" от имени которого будут создаваться документы "Заказ клиента".

*   Выберите "Способ поиска существующих элементов справочника Контрагенты" для поиска контрагентов при загрузке заказов с сайта. Есть 2 варианта поиска: по наименованию и по комбинации ИНН+КПП. В обмене данными для CS-Cart необходимо использовать вариант "По наименованию".

*   Укажите "Вид номенклатуры для товаров" — вид номенклатуры, с которым будут записываться новые товары, загруженные с сайта.

*   Укажите "Вид номенклатуры для услуг" — вид номенклатуры, с которым будут записываться новые услуги, загруженные с сайта.

*   Выберите "Единица измерения" — единица измерения, с которой будут записываться новые товары с сайта.

*   Укажите "Группа номенклатуры" — группа, в которую будут записываться товары с сайта.

*   В поле "Комментарий" добавьте комментарий к документу "Заказ клиента", если это необходимо.

В разделе **"Дополнительно"** можно настроить дополнительные параметры обмена заказами:

.. fancybox:: img/1Cimage_15.png
   :alt: Обмен данными 1C и CS-Cart

*   "Статус заказа Отменен на сайте" — устанавливает статус заказа в случае, если он "Отменен".

*   "Причина отмены заказа" — устанавливает причину присваиваемому заказу, если его статус "Отменен".

*   "Соответствие статусов заказов в информационной базе и на сайте" — настраивает соответствие статусов заказа на сайте статусам документа "Заказ клиента" в 1С. Если такие соответствия настроены, то при загрузке заказов будет происходить попытка установки соответствующего статуса документам "Заказ клиента".

После настройки всех необходимых параметров выгрузки сохраните узел, нажав на кнопку "Записать и закрыть".


Настройки в интернет-магазине
-----------------------------

Для обмена данными 1С с интернет-магазином установите модуль "CommerceML — синхронизация интернет-магазина с 1С, МойСклад, Класс365" (:doc:`см. "Установка модулей" </user_guide/addons/1manage_addons>`). 

.. note:: 

    Панель администратора → Верхнее меню → Модули → Управление модулями → "CommerceML – синхронизация интернет-магазина с 1С, МойСклад, Класс365"

.. fancybox:: /user_guide/addons/commerceml/img/commerceml_addon.png
   :alt: Модуль CommerceML в CS-Cart.

После установки модуля откройте его настройки. 

Окно "Настройки модуля" содержит вкладки:

* Общие настройки

* Характеристики

* Цены

* Доставка

* Заказы

* Товарные предложения

   
Выбор версии схемы
==================

В настройках модуля "CommerceML — синхронизация интернет-магазина с 1С, МойСклад, Класс365" есть настройка выбора схемы, которая определяет формат загрузки характеристик товара. Для определения версии схемы, необходимо:

#. Создать в 1С товар с характеристикой и сделать выгрузку в файл.

#. Открыть выгруженные из 1С файлы import.xml и offers.xml. В файлах осуществить поиск тега ``<ХарактеристикиТовара>``.

#. Если тег ``<ХарактеристикиТовара>`` нашелся в файле import или в обоих файлах, то необходимо выбрать версию схемы 2.07. Если тег нашелся только в файле offers или ни в одном из файлов, то выбрать версию схемы 2.05.


Общие настройки
===============

Вкладка "Общие настройки" содержит следующие поля:

.. fancybox:: /user_guide/addons/commerceml/img/commerceml_general_settings.png
   :alt: Общие настройки модуля CommerceML в CS-Cart.

.. list-table::
    :widths: 15 30

    *   -   Версия схемы

        -   В зависимости от формата передаваемых данных, необходимо выбрать соответствующую версию схемы:

            *   2.05 — выберите, если характеристики товара выгружаются только в файл offers. Выгрузка вариаций товаров из 1С в CS-Cart работает только со схемой 2.05.

            *   2.07 — выберите, если характеристики товара выгружаются в файл import.

    *   -   Язык по умолчанию

        -   Определяет, какой язык будет использоваться для записи данных.

    *   -   Значение для связывания категорий

        -   Используется для связывания категорий в 1С с их аналогами в CS-Cart.

    *   -   Значение для связывания товаров

        -   Используется для связывания товаров в 1C с их аналогами в CS-Cart.

    *   -   Загружать товары

        -   Определяет, какие товары будут загружаться из файла import.xml.

    *   -   Разрешить импорт категорий

        -   Определяет, будут ли загружаться группы из 1С. Если данная настройка отключена, то товары будут записаны в категорию, указанную в настройке "Категория по умолчанию".

    *   -   Категория по умолчанию

        -   Категория, в которую будут добавлены новые товары из 1С, если настройка "Разрешить импорт категорий" выключена.

    *   -   Скрывать товары, которых нет в наличии

        -   Автоматически присваивает товарам статус "Скрыто", если количество товара равно 0.

    *   -   Добавлять налог к товарам.

        -   Товарам будут добавлены налоги, используемые в 1С. 

            Настройки выгрузки налогов доступны на странице "Модули → Настройки CommerceML → Соответствие налогов".

            Для настройки выгрузки налогов необходимо указать соответствия налогов в CS-Cart и процентной ставки в 1С.

    *   -   Импортировать изображения как дополнительные

        -   Все изображения товара будут загружены как дополнительные.

    *   -   Использовать в названии товара

        -   Параметр, определяющий какие данные будут записываться в наименование товара:

            * Рабочее наименование 

            * Наименование для печати

    *   -   Использовать в коде товара

        -   Определяет какие данные будут записываться в поле код товара:

            * Артикул

            * Код номенклатуры

            * Штрихкод

    *   -   Использовать в полном описании товара

        -   Определяет какие данные будут записываться в качестве полного описания товара:

            * Текстовое описание

            * Файл описания для сайта

            * Наименование для печати

    *   -   Использовать в кратком описании товара

        -   Определяет какие данные будут записываться в качестве краткого описания товара:

            * Текстовое описание

            * Файл описания для сайта

            * Наименование для печати

    *   -   Использовать в название страницы (SEO)

        -   Параметр, определяющий какие данные будут записываться в поле название страницы:

            * Наименование

            * Полное наименование


Характеристики
==============
        
Вкладка "Характеристики" содержит следующие настройки:

.. fancybox:: /user_guide/addons/commerceml/img/commerceml_features.png
   :alt: Импорт характеристик по CommerceML в CS-Cart.

.. list-table::
    :widths: 15 30

    *   -   Разрешить импорт свойств

        -   Свойства из 1С будут загружены в магазин.

    *   -   Название свойства для промо-текста

        -   В качестве промо-текста для товара будет загружено значение указанного свойства из 1С.

    *   -   Значение, используемое для бренда

        -   Значение, которое будет загружено в качестве бренда.

    *   -   Название свойства для бренда

        -   В качестве бренда будет загружено указанное свойство из 1С, если в поле "Значение, используемое для бренда" выбрано значение "Свойство товара".

    *   -   Настройка запрета/разрешения выгрузки свойств

        -   Выбор метода исключения для загружаемых свойств:

            * Не использовать функцию запрета/разрешения выгрузки свойств

            * Загружать только

            * Не загружать

    *   -   Список свойств для запрета/разрешения выгрузки

        -   Список свойств для разрешения или запрета загрузки. Каждое свойство необходимо вводить с новой строки.


Цены
====
        
Вкладка "Цены" содержит настройки загрузки цен:

.. fancybox:: /user_guide/addons/commerceml/img/commerceml_price_settings.png
   :alt: Настройки импорта цен по CommerceML в CS-Cart.

Если настройка **Импортировать количество и цены** включена, то в магазин будут загружаться цены и количество товаров, выгруженных из 1С.
   
Включите настройку **Загружать несколько цен** для загрузки нескольких цен (Базовая цена, Рекомендованная цена, Оптовые цены).

Настройка **Запустить режим отладки цен** нужна для проверки цен, введённых на странице "Модули → Настройки CommerceML → Соответствие цен".

Загрузка нескольких цен реализована с помощью цен для групп пользователей. Вы можете задать для каждой группы пользователей (Опт, Розница, Золотой клиент) свою цену на товар.

Для настройки выгрузки цен и соответствия цен группам пользователей в CS-Cart перейдите на страницу "Модули → Настройки CommerceML → Соответствие цен".

Если существует необходимость выгрузки нескольких видов цен в одну цену, то их можно добавить в настройках через запятую.

Страница "Соответствие цен" содержит поля:

*   "Базовая цена" — это цена товара по умолчанию для всех групп пользователей; 

*   "Рекомендованная цена" — это рекомендованная цена товара в разделе "Ценообразование/наличие";

*   "Цена в магазине" — это цена, которая будет доступна для указанной группы пользователей.
    
.. fancybox:: /user_guide/addons/commerceml/img/commerceml_prices.png
   :alt: Таблица соответствия цен в системе учёта и в CS-Cart при обмене по CommerceML.


Для проверки введенных названий цен (соглашений) в модуле предусмотрено тестирование выгружаемых цен. Для тестирования:

#. Установите галочку "Запустить режим отладки цен" в настройках модуля.

#. В 1С произведите выгрузку в интернет-магазин.

#. Далее перейдите на страницу "Соответствие цен" в панели администратора и посмотрите результат. Внесите исправление и обновите страницу. 

#. Для полноценной выгрузки уберите галочку "Запустить режим отладки цен" в настройках модуля "CommerceML — синхронизация интернет-магазина с 1С, МойСклад, Класс365" и повторите выгрузку.


Доставка
========
    
Вкладка "Параметры доставки" настраивает загрузку дополнительных реквизитов номенклатуры (в одном поле можно указать несколько реквизитов для каждого вида номенклатуры с новой строки) и содержит следующие настройки:
    
.. fancybox:: /user_guide/addons/commerceml/img/commerceml_shipping.png
   :alt: Настройки доставки в модуле CommerceML в CS-Cart.

.. list-table::
    :widths: 15 30

    *   -   Наименование свойства для веса

        -   Выгружаемый дополнительный реквизит номенклатуры. Тип значения реквизита в 1С — Число.

    *   -   Отображать вес, как характеристику

        -   По весу товара будет создана характеристика (для фильтра товаров по характеристикам).

    *   -   Наименование свойства для бесплатной доставки

        -   Выгружаемый дополнительный реквизит номенклатуры. Тип значения реквизита в 1С — Булево.

    *   -   Отображать бесплатную доставку как характеристику

        -   По параметру "Бесплатная доставка товара" будет создана характеристика товара.

    *   -   Стоимость доставки

        -   Дополнительный реквизит номенклатуры. Тип значения реквизита в 1С — Число.

    *   -   Количество штук в коробке

        -   Дополнительный реквизит номенклатуры. Тип значения реквизита в 1С — Число.

    *   -   Длина коробки

        -   Дополнительный реквизит номенклатуры. Тип значения реквизита в 1С — Число.

    *   -   Ширина коробки

        -   Дополнительный реквизит номенклатуры. Тип значения реквизита в 1С — Число.

    *   -   Высота коробки

        -   Дополнительный реквизит номенклатуры. Тип значения реквизита в 1С — Число.


Заказы
======
    
Вкладка "Заказы" содержит следующие поля:

.. fancybox:: /user_guide/addons/commerceml/img/commerceml_orders.png
   :alt: Настройки синхронизации заказов по CommerceML в CS-Cart.

.. list-table::
    :widths: 15 30
    
    *   -   Включать отдельно стоимость доставки заказа
    
        -   Доставка будет выгружена в виде отдельной номенклатуры.

    *   -   Выгружать опции товара
    
        -   В заказах товары, имеющие опции, будут выгружаться с опциями. Будут загружаться только те опции, которые изначально были созданы в 1С; опции созданные в магазине загружаться не будут.

    *   -   Выгружать с номера
    
        -   Для загрузки будут доступны заказы, начиная с указанного номера.

    *   -   Загружать статусы заказов
    
        -   В магазин будут загружены статусы для соответствующих заказов, выгруженные в файл orders.

    *   -   Выгружать статусы заказов
    
        -   Из магазина будут выгружены заказы со статусами.

    *   -   Выгрузить все товары магазина

        -   Заказы из магазина выгружаться не будут. Вместо этого будут выгружены все включенные товары, у которых включена настройка "Обновлять товар".

    *   -   Статусы выгружаемых заказов
    
        -   Статусы заказов, которые будут выгружены.


Товарные предложения
====================
        
Эквивалентом товарных предложений в CS-Cart являются :doc:`вариации товаров </user_guide/manage_products/products/product_variations>`. Если установлен и включен модуль :doc:`Вариации товаров </user_guide/addons/product_variations/index>`, то для импорта товарных предложений больше ничего не потребуется.

.. important::

    В старых версиях вместо вариаций были комбинации опций. Если вы раньше выгружали из 1С их, то после обновления вы всё ещё сможете это делать. На вкладке "Товарные предложения" в этом случае у вас будет возможность переключиться на вариации.

.. fancybox:: /user_guide/addons/commerceml/img/commerceml_offers.png
   :alt: Настройки выгрузки товарных предложений в CS-Cart по CommerceML.


Обмен данными между 1С и CS-Cart
--------------------------------

Обмен данными между 1С и CS-Cart можно осуществлять одним из способов:

* Автоматический запуск
    
  Для автоматического запуска обмена достаточно настроить расписание автоматического обмена данными в форме узла обмена данными.

* Ручной запуск

  Для запуска обмена данными откройте созданный узел обмена и нажмите на кнопку "Выполнить обмен", будет запущен процесс обмена, по окончании которого будет выдано соответствующее сообщение.

.. fancybox:: img/1Cimage_26.png
   :alt: Обмен данными 1C и CS-Cart

Для анализа результатов обмена используется журнал регистрации «1С: Предприятия».

Для просмотра событий выгрузки данных в окне созданного узла обмена необходимо нажать кнопку "Все действия" → "События выгрузки данных". Откроется окно "Журнал регистрации".
    
.. fancybox:: img/1Cimage_27.png
    :alt: Обмен данными 1C и CS-Cart
    
В форме "Журнал регистрации" для просмотра истории обмена открываются строки журнала и анализируется содержащаяся в них информация. Для быстрого просмотра протокола обмена по строке журнала достаточно нажать на поле "Комментарий" и откроется окно "Событие":
    
.. fancybox:: img/1Cimage_28.png
    :alt: Обмен данными 1C и CS-Cart
    
Для просмотра и удаления объектов, зарегистрированных для выгрузки, в окне созданного узла обмена нажмите на кнопку "Все действия" → "Показать зарегистрированные изменения". В форме отображаются группы (виды) объектов: Товары, Файлы и Заказы. Если необходимо отменить (удалить) регистрацию конкретного объекта, необходимо выбрать его и нажать на кнопку [x]:
    
.. fancybox:: img/1Cimage_29.png
    :alt: Обмен данными 1C и CS-Cart
