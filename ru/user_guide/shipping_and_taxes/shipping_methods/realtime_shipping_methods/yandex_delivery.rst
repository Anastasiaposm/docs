***************
Яндекс.Доставка
***************

.. note::

    Начиная с версии **CS-Cart 4.6.2**, для корректной работы сервиса "Яндекс.Доставка" необходимо, прежде всего, настроить существующие налоги с помощью :doc:`модуля "Налоговые ставки РФ" </user_guide/addons/rus_taxes/index>`.

.. epigraph::

   Сервис работает с несколькими курьерскими службами и помогает организовать перевозку товаров из Москвы и Подмосковья во все регионы России.
   Перевозка товаров при работе с Яндекс.Доставкой в среднем стоит столько же, сколько при работе с курьерскими службами напрямую.

   -- |yandex_delivery|

.. |yandex_delivery| raw:: html

    <!--noindex--><a href="https://delivery.yandex.ru/promo/" target="_blank" rel="nofollow">Официальный сайт</a><!--/noindex-->

.. note::

    В версии **CS-Cart 4.6.1** появилась возможность настроить курьерскую доставку. В более ранних версиях была реализована только доставка до точек самовывоза.

=============
Ключи доступа
=============

#. Откройте в браузере страницу delivery.yandex.ru и перейдите на страницу настроек:

   .. fancybox:: img/go_to_settings.png
       :alt: Переход на страницу настроек на стороне Яндекс.Доставки

#. Откройте вкладку "Интеграция" и нажмите на ссылку "получить".

   .. fancybox:: img/get_api_keys.png
       :alt: Получение API ключей на стороне Яндекс.Доставки

#. Скопируйте и вставьте данные в настройки модуля CS-Cart. В первом поле отображаются "Ключи API", а во втором значения "Client ids".

   .. fancybox:: img/copy_api_keys.png
       :alt: Копирование ключей

================
Настройка модуля
================

#. Установите модуль.

#. В настройках модуля укажите значения, который получили в окне "Получить API-ключи" на сайте delivery.yandex.ru.

   .. fancybox:: img/settings_addon.png
       :alt: Настройки модуля "Яндекс.Доставка"

===========================
Добавление способа доставки
===========================

#. Создайте новый способ доставки (:doc:`см. "Создание способа доставки" </user_guide/shipping_and_taxes/shipping_methods/add_shipping_method>`).

   Настройки нового способа доставки:

   .. list-table::
       :stub-columns: 1
       :widths: 10 30

       *   -   Расчет тарифа
           -   В реальном времени

       *   -   Служба доставки
           -   Яндекс.Доставка

   .. fancybox:: img/yandex_delivery_shipping_method.png
       :alt: Добавление нового способа доставки

#. Выполните настройку нового способа доставки во вкладке “Настроить”.

   .. fancybox:: img/yandex_delivery_shipping_settings.png
       :alt: Настройка Яндекс.Доставки

   .. list-table::
       :stub-columns: 1
       :widths: 20 30

       *   -   Отправитель, склад, реквизиты

           -   Ваши данные, которые вы настраиваете на стороне Яндекса.

       *   -   Ширина упаковки, высота упаковки, длина упаковки

           -   Размеры посылки.

       *   -   Тип доставки

           -   Курьерская доставка или доставка до пункта самовывоза.

       *   -   Сортировка точек самовывоза

           -   Когда покупатель указал адрес доставки, то в списках доступных точек самовывоза доступны самые близкие от него. Это удобно при использовании следующей настройки.

       *   -   Количество отображаемых точек самовывоза

           -   В больших городах много точек самовывоза. Этой настройкой можно ограничить их количество в списке, оставив только ближайшие к клиенту точки самовывоза.

       *   -   Отправить из

           -   Город, из которого Яндекс.Доставка отправит товар. Если ваш склад находится в Московской области, то выберите *Москва*, а если в Ленинградской области, то *Санкт-Петербург*.

       *   -   Службы доставки

           -   Службы доставки, которые можно будет выбрать при оформлении и редактировании заказа. Здесь появляются только те службы, которые включены у вас в личном кабинете Яндекс.Доставки.

       *   -   Журнал событий

           -   По умолчанию запись в журнал событий отключена. Яндекс присылает большие объемы данных, поэтому включение журнала событий может привести к медленной работе магазина при оформлении заказа.

#. Проверьте работу автоматического расчёта стоимости доставки.

   .. fancybox:: img/test.png
       :alt: Проверка расчета стоимости Яндекс.Доставки

=================
Оформление заказа
=================

#. Добавляем товар в корзину и переходим на оформление заказа.

#. На третьем шаге оформления заказа выбираем способ доставки *Яндекс.Доставка*.

#. Выбор способа доставки может выглядеть по-разному, в зависимости от типа доставки:

   * Если выбран тип "До пункта самовывоза", то отобразится карта, на которой покупатель сможет выбрать подходящий пункт. 

     .. fancybox:: img/all_points.png
         :alt: Карта с пунктами самовывоза при оформлении заказа

     .. fancybox:: img/select_point.png
         :alt: Выбранный пункт самовывоза

   * Если выбран тип "Курьером", то отобразится просто список служб доставки с их ценами.

     .. fancybox:: img/yandex_courier.png
         :alt: Добавление нового способа доставки

==================================
Создание заказа на Яндекс.Доставке
==================================

После того, как покупатель оформит заказ в магазине, администратор может создать соответствующий заказ на Яндекс.Доставке. 

.. important::

    Для создания заказа на Яндекс.Доставке необходимо, чтобы в заказе был указан сотовый телефон покупателя. Стоимость товаров должна быть целочисленной.

#. Откройте страницу **Заказы → Все заказы**.

#. Найдите и откройте заказ, для которого хотите создать заказ на Яндекс.Доставке.

#. Создайте отгрузку. Есть два варианта, как это сделать:

   * В поле **Перевозчик** в правой части экрана выберите вариант *Яндекс.Доставка*. Затем нажмите **Сохранить изменения**.

   * Нажмите **Создать отдельную отгрузку**, в появившемся окне выберите в поле **Перевозчик** вариант *Яндекс.Доставка* и нажмите кнопку **Создать**.

   .. fancybox:: img/yandex_delivery.png
       :alt: Создание отгрузки для Яндекс.Доставки в CS-Cart

   .. note::

       Не рекомендуем на этом этапе отправлять покупателю письмо о создании отгрузки. Это лучше сделать чуть позже, в шаге 5 — так мы отправим одно уведомление вместо двух, а в уведомлении уже будет номер отслеживания от Яндекс.Доставки.

#. После того, как отгрузка создана, на странице заказа появится кнопка **Оформить заказ Яндекс.Доставки**. Нажмите на неё.

   .. fancybox:: img/create_yandex_delivery_order.png
       :alt: Создание заказа на Яндекс.Доставке в CS-Cart.

#. Откроется всплывающее окно, где можно будет настроить заказ:

   * Вкладка **Общее**: выберите отправителя, склад и реквизиты. Добавьте комментарий, если необходимо. Можно отправить покупателю уведомление об отправке (уже с номером отслеживания).

     .. fancybox:: img/yd_general.png
         :alt: Яндекс.Доставка в CS-Cart: отправитель, склад, реквизиты, комментарий, уведомление об отправке.

   * Вкладка **Поставка**: выберите дату и способ отгрузки. Здесь есть ещё два важных поля:

     * **Оценочная стоимость** — сумма, которую вам вернут, если при перевозке товаров с ними что-то произойдет.

     * **Предоплата** — сумма, которую покупатель уже уплатил за заказ.

     .. fancybox:: img/yd_shipping.png
         :alt: Яндекс.Доставка в CS-Cart: дата и способ отгрузки, предоплата, оценочная стоимость.
 
   * Вкладка **Информация о пользователе**: введите имя, фамилию и номер мобильного телефона покупателя.

     .. fancybox:: img/yd_customer.png
         :alt: Яндекс.Доставка в CS-Cart: имя, фамилия и номер мобильного телефона покупателя.

#. Нажмите кнопку **Создать**. Заказ на Яндекс.Доставке будет создан, а на странице заказа в CS-Cart появится номер отслеживания.

   .. fancybox:: img/order_on_yandex_delivery.png
       :alt: Заказ из CS-Cart на Яндекс.Доставке

   .. important::

       В CS-Cart информация о статусе заказа на Яндекс.Доставке обновляется автоматически, но **только когда пользователь или администратор открывает в CS-Cart страницу соответствующего заказа** (но не список отгрузок).

   .. fancybox:: img/yd_order_confirmed.png
       :alt: Статус заказа на Яндекс.Доставке в CS-Cart обновляется автоматически, если открыть страницу заказа в CS-Cart

   .. hint::

       Чтобы найти все отгрузки, для которых был создан заказ на Яндекс.Доставке, откройте страницу **Заказы → Отгрузки** и выберите **Заказы Яндекс.Доставки** в панели справа.

   .. fancybox:: img/yandex_shipments.png
       :alt: Список отгрузок CS-Cart, связанных с заказами на Яндекс.Доставке

===========================================
Добавление данных о точке самовывоза в счёт
===========================================

.. important::

    Эта возможность впервые появилась в CS-Cart 4.5.1.

Когда включен модуль **Яндекс.Доставка**, то в :doc:`редакторе документов </user_guide/look_and_feel/documents/index>` можно добавить информацию о точке самовывоза, выбранной при создании заказа. Например, добавить информацию о точке самовывоза в счёт можно так:

#. Перейдите на страницу **Дизайн → Документы**.

#. Откройте документ **Счёт**.

   .. fancybox:: img/order_document_list.png
       :alt: Находим "Счет" в списке документов CS-Cart

#. Среди переменных, относящихся к ``order``, найдите массив ``pickup_data``. В нём содержатся переменные с информацией о точке самовывоза.

#. Добавьте необходимые переменные в нужное место документа. Например, на картинке ниже мы добавили информацию о точке самовывоза вместо номера отслеживания.

   .. fancybox:: img/yandex_pickup_data.png
       :alt: Редактируем шаблон счёта

#. Проверьте результат. Например, у нас информация о точке самовывоза выглядит так:

   .. fancybox:: img/pickup_point_in_invoice.png
       :alt: Информация о точке самовывоза в счёте

   Чтобы добавить cебе в счёт такой же фрагмент, как на картинке, перейдите в режим редактирования кода с помощью кнопки *<>* и добавьте в нужное место следующий код::

     <p style="color: #787878; font-size: 14px; font-family: Helvetica, Arial, sans-serif; padding-bottom: 5px; margin: 0px;">

         <span style="color: #000000; font-weight: 600; font-family: Helvetica, Arial, sans-serif; text-transform: uppercase;">{{__("PICKUP")}}
         </span>

         {{ o.pickup_data.delivery_name }}
     </p>

     <p style="color: #787878; font-size: 14px; font-family: Helvetica, Arial, sans-serif; padding-bottom: 5px; margin: 0px;">
         {{ o.pickup_data.full_address }}
     </p>
