***************
Яндекс.Доставка
***************

.. note::

    Начиная с версии **CS-Cart 4.6.2**, для корректной работы сервиса "Яндекс.Доставка" необходимо, прежде всего, настроить существующие налоги с помощью модуля :doc:`/user_guide/addons/rus_taxes/index`.

`Яндекс.Доставка <https://dostavka.yandex.ru/>`_ работает с несколькими курьерскими службами и помогает организовать доставку товаров почти во все регионы России. Перевозка товаров при работе с сервисом в среднем стоит столько же, сколько при работе с курьерскими службами напрямую.

.. contents::
   :backlinks: none
   :local:

================
Настройка модуля
================

#. В панели администратора на странице **Модули → Управление модулями** найдите модуль "Яндекс.Доставка" и установите его.

#. В настройках модуля укажите:

   * **Токен авторизации (Oauth)**;
   
     Чтобы получить токен, следуйте `инструкции Яндекса <https://yandex.ru/dev/delivery-3/doc/dg/concepts/access.html#access__token>`_.
   
   * **ID учётной записи**;
   
     Получить значение ID можно в `личном кабинете магазина Яндекс.Доставки <https://partner.market.yandex.ru/businesses>`_, там оно называется **ID магазина**.
 
   * **Идентификаторы магазинов из Яндекса**;
   
   * **Идентификаторы складов из Яндекса**.
   
     Чтобы получить идентификаторы магазинов или складов, в личном кабинете Яндекс.Доставки перейдите на страницу **Настройки → Магазины**. В строке нужного магазина/склада вы увидите значение *Идентификатора*.

===========================
Добавление способа доставки
===========================

#. :doc:`Создайте новый способ доставки </user_guide/shipping_and_taxes/shipping_methods/add_shipping_method>` и задайте :doc:`его свойства </user_guide/shipping_and_taxes/shipping_methods/shipping_method_attributes>`:

    Обязательно укажите:
    
    * **Название** — введите название способа доставки, которое покупатель увидит при оформлении заказа;

    * **Расчёт тарифа** — выберите *Яндекс.Доставка* как один из способов расчёта *в режиме реального времени*.

   .. fancybox:: img/yandex_delivery_shipping_method.png
       :alt: Добавление нового способа доставки

#. Выполните настройку нового способа доставки.

   На вкладке **Настроить**:

   .. list-table::
       :stub-columns: 1
       :widths: 17 30

       *   -   Склад, магазин в Яндекс.Доставке

           -   Выберите склад/магазин из списка доступных, который вы добавили при настройке модуля "Яндекс.Доставка".

       *   -   Ширина упаковки, высота упаковки, длина упаковки

           -   Размеры посылки — значения размера посылки по умолчанию.

       *   -   Тип доставки

           -   Курьерская доставка или доставка до пункта самовывоза.

       *   -   Службы доставки

           -   Службы доставки, которые можно будет выбрать при оформлении и редактировании заказа. Здесь появляются только те службы, которые включены у вас в личном кабинете Яндекс.Доставки.

   .. fancybox:: img/yandex_delivery_shipping_settings.png
       :alt: Настройка Яндекс.Доставки
       
#. Проверьте работу автоматического расчёта стоимости доставки.

   .. fancybox:: img/test.png
       :alt: Проверка расчета стоимости Яндекс.Доставки

=================
Оформление заказа
=================

#. Добавляем товар в корзину и переходим на оформление заказа.

#. В качестве способа доставки выберите *Яндекс.Доставка*.

#. Выбор способа доставки может выглядеть по-разному, в зависимости от типа доставки:

   * Если выбран тип доставки "Самовывоз", то отобразится карта, на которой покупатель сможет выбрать подходящий пункт. 

     .. fancybox:: img/select_point.png
         :alt: Выбранный пункт самовывоза

   * Если выбран тип "Курьером", то отобразится просто список служб доставки с их ценами.

     .. fancybox:: img/yandex_courier.png
         :alt: Выбор службы доставки

==================================
Создание заказа в Яндекс.Доставке
==================================

После того, как покупатель оформит заказ в магазине, администратор может создать соответствующий заказ в Яндекс.Доставке. 

.. important::

    Для создания заказа в Яндекс.Доставке необходимо, чтобы в заказе был указан сотовый телефон покупателя. Стоимость товаров должна быть целочисленной.

#. Откройте страницу **Заказы → Все заказы**.

#. Найдите и откройте заказ, для которого хотите создать заказ в Яндекс.Доставке.

#. Создайте отгрузку. Есть два варианта, как это сделать:

   * В поле **Перевозчик** в правой части экрана выберите вариант *Яндекс.Доставка*. Затем нажмите **Сохранить изменения**.

   * Нажмите **Создать отдельную отгрузку**, в появившемся окне выберите в поле **Перевозчик** вариант *Яндекс.Доставка* и нажмите кнопку **Создать**.

     .. fancybox:: img/yandex_delivery.png
         :alt: Создание отгрузки для Яндекс.Доставки в CS-Cart

   .. note::

       Не рекомендуем на этом этапе отправлять покупателю письмо о создании отгрузки. Это лучше сделать чуть позже, в шаге 5 — так мы отправим одно уведомление вместо двух, а в уведомлении уже будет номер отслеживания от Яндекс.Доставки.

#. После того, как отгрузка создана, нажмите на кнопку **Создать заказ в Яндекс.Доставке**.

   .. fancybox:: img/create_yandex_delivery_order.png
       :alt: Создание заказа в Яндекс.Доставке в CS-Cart.

#. Откроется всплывающее окно, где можно будет настроить заказ:

   * Вкладка **Информация об отгрузке**: выберите дату и тип отгрузки, добавьте комментарий, если необходимо. Можно отправить покупателю уведомление об отправке. Здесь есть ещё два важных поля:

     * **Оценочная стоимость** — сумма, которую вам вернут, если при перевозке товаров с ними что-то произойдет.

     * **Предоплата** — сумма, которую покупатель уже уплатил за заказ.
     
     .. fancybox:: img/yd_shipping.png
         :alt: Яндекс.Доставка в CS-Cart: дата и способ отгрузки, предоплата, оценочная стоимость.
     
   * Вкладка **Информация о покупателе**: введите имя, фамилию и контактуную информацию о покупателе.

     .. fancybox:: img/yd_customer.png
         :alt: Яндекс.Доставка в CS-Cart: имя, фамилия и номер мобильного телефона покупателя.
         
   * Вкладка **Информация о курьере**: пеший курьер или на машине, его имя, фамилия и телефон. 

     .. fancybox:: img/yd_courier.png
         :alt: Яндекс.Доставка в CS-Cart: отправитель, склад, реквизиты, комментарий, уведомление об отправке.
   
   * Вкладка **Другая информация**: заполнение информации о магазине и складе в Яндекс.Доставке.
     
     .. fancybox:: img/yd_additional.png
         :alt: Яндекс.Доставка в CS-Cart: информация о магазине/складе.
         
#. Нажмите кнопку **Создать**. Заказ в Яндекс.Доставке будет создан, а на странице заказа в CS-Cart появится номер этого заказа в Яндексе.

   .. fancybox:: img/order_on_yandex_delivery.png
       :alt: Заказ из CS-Cart в Яндекс.Доставке

   .. important::

       В CS-Cart информация о заказе в Яндекс.Доставке обновляется автоматически, но только когда пользователь или администратор открывает в CS-Cart страницу соответствующего заказа (но не список отгрузок).

   .. fancybox:: img/yd_order_confirmed.png
       :alt: Номер заказа в Яндекс.Доставке в CS-Cart обновляется автоматически, если открыть страницу заказа в CS-Cart