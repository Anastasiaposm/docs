Настройка покупки на Маркете
----------------------------

Перед тем, как подключать магазин к Яндекс.Маркету, настройте отправку прайс-листа вашего магазина в Яндекс.Маркет.

Чтобы иметь возможность продавать товары непосредственно через Яндекс.Маркет, ваш магазин должен отправлять прайс-лист в течение не менее трех месяцев (это обязательное условие Яндекс.Маркета).

.. important::
   
    Для работы необходимо `использование SSL-сертификата и протокола HTTPS <https://yandex.ru/support/partnermarket/purchase/api-faq.xml#http-ssl>`_. Пользователям Мерчиума об этом беспокоиться не нужно — достаточно просто настроить все, как указано в статье.

Выполните следующие шаги, чтобы подключить свой магазин к Яндекс.Маркету:

#. Войдите в личный кабинет в Яндекс.Маркете.

#. Перейдите на страницу **Заказ на Маркете → Настройки API заказа**.

   .. fancybox:: img/go_settings.png
       :alt: Переход в настройки

#. Заполните поля следующим образом:

   .. list-table::
       :stub-columns: 1
       :widths: 15 30

       *   -   URL API

           -   | Для CS-Cart: *https://example.com/api/ym/*, где example.com необходимо заменить на ваш домен магазина.
               | Для Мерчиума: *https://MYSTORE.mymerchium.ru/api/ym/*, где MYSTORE — название вашего магазина на Мерчиуме (появляется в адресной строке браузера при нахождении в панели администратора Мерчиума).

       *   -   SHA1 fingerprint

           -   | Для CS-Cart: SHA1 fingerprint вашего SSL сертификата домена магазина.
               | Для Мерчиума: *1A:45:1D:B9:CD:AF:17:89:40:18:80:1E:70:0A:D5:B1:B5:4F:65:FD*

       *   -   Авторизационный токен

           -   При нажатии кнопки изменить у вас сгенерируется новый токен

       *   -   Тип авторизации

           -   Выбрать URL

       *   -   Формат данных

           -   Выбрать JSON


   .. fancybox:: img/api_settings.png
       :alt: API настройки


#. Скопируйте значение поля **Авторизационный токен** (см. изображение выше).

#. В новой вкладке браузера (или в новом окне) войдите в панель администратора магазина, на страницу **Модули → Яндекс.Маркет**.

   .. fancybox:: img/go_settings_addon.png
       :alt: переход в настройки модуля

#. Переключитесь во вкладку **Покупка на Маркете**.

   .. fancybox:: img/go_tab.png
       :alt: переход в настройки модуля


#. Скопированное на 4-ом шаге значение вставьте в поле **Авторизационный токен**.

   .. fancybox:: img/settings_addon.png
       :alt: Настройки модуля


#. Скопируйте номер кампании из личного кабинета в Яндекс.Маркете (в правом верхнем углу, под названием магазина) и вставьте его в поле **Номер кампании**.

   .. fancybox:: img/number_company.png
       :alt: Номер компании


#. В поле **Логин пользователя** введите имя пользователя в Яндексе, которое вы используете для входа в личный кабинет в Яндекс.Маркете.

#. В новой вкладке браузера (или в новом окне) перейдите на страницу |yandex_reg_app|.

#. В поле **Название** введите «My Store» (или любое другое название, это не важно).

#. В списке прав выберите Яндекс.Маркет и поставьте галочку в поле **API Яндекс.Маркета** для партнеров.

   .. fancybox:: img/api_yandex_market.png
       :alt: Настройка приложения

#. В поле **Callback URL** введите:

   * для CS-Cart: *http://example.com/admin.php?dispatch=ym_tools.oauth*, где *http://example.com* — адрес вашего магазина в интернете, а *admin.php* — название скрипта панели администратора. Скорее всего, его :doc:`переименовали сразу после установки. <../../../install/secure/index>`
   
     .. note::
     
         Если на странице **Настройки → Настройки безопасности** включено безопасное соединение для панели администратора, используйте *https://* вместо *http://*.

   * для Мерчиума: *https://example.com/admin/?dispatch=ym_tools.oauth*, где *https://example.com* — адрес вашего магазина в интернете.

#. На странице приложения скопируйте значение поля **ID** и вставьте его в поле **ID**, в значение поля **Пароль** — в поле **Пароль приложения**.

#. В панели администратора магазина нажмите на кнопку **Сохранить**.

#. После сохранения под формой появится ссылка для авторизации приложения. Нажмите на нее.

   .. fancybox:: img/refresh_token.png
       :alt: Ссылка для авторизации приложения.

#. На странице авторизации нажмите на кнопку **Разрешить**.

   .. fancybox:: img/allow_access.png
       :alt: Разрешить приложению доступ к данным Яндекса.

#. Откройте файл **config.local.php** на сервере в корневой директории CS-Cart. Замените

   ::
   
     'api_allow_customer' => false,
     
   на 

   ::
   
     'api_allow_customer' => true,

   и сохраните изменения. 
   
   .. note::
   
       В Мерчиуме эта настройка включена по умолчанию.

#. Перейдите на страницу **Администрирование → Способы доставки** в панели администратора. Откройте каждый используемый способ доставки и укажите значение настройки **Яндекс.Маркет Тип доставки**.

   Если выбран *Cамовывоз*, то в поле **Яндекс.Маркет Пункты самовывоза** также укажите через запятую и без пробелов **Идентификаторы точек продаж**, созданных в партнерском интерфейсе на странице **Настройки → Точки продаж**.

После того, как вы выполните все шаги, вы сможете продавать товары из своего магазина непосредственно на Яндекс.Маркете.
При размещении заказа в Яндекс.Маркете в вашем магазине также будет автоматически создан заказ.


.. |yandex_reg_app| raw:: html

    <!--noindex--><a href="https://oauth.yandex.ru/client/new" target="_blank" rel="nofollow">регистрации приложения Яндекса</a><!--/noindex-->

.. |oauth| raw:: html

   https://example.com/admin/?dispatch=ym_tools.oauth

.. |example| raw:: html

    http://example.com

.. |example_api| raw:: html

    https://example.com/api/ym/
