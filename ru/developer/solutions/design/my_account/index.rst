***********************************************************
Создание нового шаблона для блока (на основе «Мой профиль»)
***********************************************************

.. contents::
    :local: 
    :depth: 3

Описание
========

Стандартная функциональность
----------------------------

Стандартная функциональность CS-Cart и Multi-Vendor включает блок «Мой профиль» , который содержит:

*   Быстрый доступ к заказам и загрузкам

*   Кнопки для регистрации и авторизации покупателей

*   **Отслеживание заказа**

*   Полезные ссылки для покупателей

Блок "Мой профиль" может быть отображен как:

.. list-table::
    :header-rows: 1
    :widths: 30 30

    *   -   Всплывающий блок

        -   Простой блок в любом месте сайта

    *   -   .. image:: img/new_my_account_02.png
                :alt: Новый блок

        -   .. image:: img/new_my_account_01.png
                :alt: Новый блок

Что будем делать
----------------

Мы создадим новый шаблон для блока «Мой профиль» на основе существующего. У блока будет два шаблона, выбор шаблона будет доступен в панели администратора. Новый шаблон блока будет выполнять одну единственную функцию — **отследить заказ**. 

Другими словами новый шаблон, будет обрезанной копией существующего шаблона. Однако это не помешает вам добавить по данному любой код в новый шаблон.

На витрине:

.. list-table::
    :header-rows: 1
    :widths: 30 30

    *   -   Обычный шаблон

        -   Дополнительный шаблон

    *   -   .. image:: img/new_my_account_01.png
                :alt: Новый блок

        -   .. image:: img/new_my_account_18.png
                :alt: Новый блок


В панели администратора:

.. list-table::
    :header-rows: 1
    :widths: 30 30

    *   -   Было

        -   Стало

    *   -   .. fancybox:: img/new_my_account_04.png
                :alt: Новый блок

        -   .. fancybox:: img/new_my_account_11.png
                :alt: Новый блок



Чем будет полезен данный урок?
------------------------------

Вы узнаете:

1.  Как формируются и подключаются блоки и шаблоны блоков.

2.  Как создавать свои блоки или шаблоны на основе стандартных блоков.

3.  Как расширить сущестующий блок с помощью модуля.


Анализ
======

Каждый блок в CS-Cart или Multi-Vendor имеет:

1.  TPL шаблон

    *Шаблон который отображается на витрине*

2.  PHP схему, 

    *Содержит информацию о блоке, необходима чтобы блок стал доступен в платформе.*

Анализируем существующий блок «Мой профиль»
-------------------------------------------

Поиск TPL шаблона
*****************

Нам нужно найти как формируется и отображается существующий блок «Мой профиль», чтобы потом сделать его дубликат и изменить содержимое. 

1.  Проходим в «Редактирование макетов» панели администратора.

    .. note::

        Верхнее меню → Дизайн → Макеты


    Создаём новый блок «Мой профиль» или находим существующий:

    .. image:: img/new_my_account_03.png
        :alt: Новый блок

    Открываем параметры блока, нажав на шестерёнку. 

    .. fancybox:: img/new_my_account_04.png
        :alt: Новый блок

    Нас интересует настройка «Шаблон». Данная настройка позволяет выбрать шаблон из доступных. По умолчанию шаблон всего один.

    Да, шаблон называется «Мой профиль», однако если посмотреть код, то можно узнать фактическое название и расположение подключаемого шаблона.

    Смотрим код списка.

    .. image:: img/new_my_account_05.png
        :alt: Новый блок

    Значение ``value`` для элемента списка равно ``blocks/my_account.tpl``

    Таким образом мы узнали какой шаблон будет подключен на витрине.

2.  Все шаблоны дизайна витрины находятся в папке:

    ``/design/themes/[название_темы]/templates``

    Проходим в данную папку.

3.  Как мы узнали ранее, нас интересует шаблон ``blocks/my_account.tpl``.

    Находим и открываем файл: 

    ``/design/themes/[название_темы]/templates/blocks/my_account.tpl``

    Мы увидим:

    .. literalinclude:: files/my_account_1.tpl
        :linenos:

    Добавим ``<p>Test</p>``, чтобы проверить правильный ли блок мы нашли.

    .. literalinclude:: files/my_account_1_test.tpl
        :emphasize-lines: 3
        :linenos:

    Проверяем отображение на витрине:

    .. image:: img/new_my_account_06.png
        :alt: Новый блок  

    Слово Test появилось. Отлично, нужны шаблон найден.

    .. note::

        Обязательно включите "Автоматическую очистку кэша" или очищайте кэш вручную.


Поиск PHP схемы блока
*********************

PHP схема описывает настройки блока и шаблона. Без PHP схемы блок не будет работать и не будет доступен в панели администратора.

PHP схемы стандартных блоков находятся в папке:

``app/schemas/block_manager``

PHP схемы блоков и шаблонов которые добавляют модули и аддонов находятся в папке:

``app/addons/[идентификатор_аддона]/schemas/block_manager``

Приступим к поиску PHP схемы блока «Мой профиль»:

1.  Проходим в папку:

    ``app/schemas/block_manager``

    Схемы блоков содержатся в файле ``blocks.php``

    Открываем файл:

    ``app/schemas/block_manager/blocks.php``

2.  Видим массив с данными блоков. Находим ячейку с информацией о блоке «Мой профиль». Так как мы знаем название шаблона, то ищем по названию шаблона ``my_account``. Названия ячеек соответствуют типу блока, поэтому найти нужный не сложно.

    .. literalinclude:: files/schema.php
        :emphasize-lines: 1,3
        :linenos:

    Проверим, правильно ли мы нашли схему. 

    Логично что, за подключение шаблонов отвечает ячейка ``templates``. Она представляет из себя массив с перечисленными шаблонами (по умолчанию один). Добавим ещё одну строчку, по аналогии с существующей.

    .. literalinclude:: files/schema_test.php
        :emphasize-lines: 4
        :linenos:    

    Проверяем в параметрах блока панели администратора. Должен появится ещё один шаблон:

    .. fancybox:: img/new_my_account_07.png
        :alt: Новый блок

    Он пока не имеет названия, поэтому называется исходя из схемы.

3.  Схема найдена. Возвращаем всё к первоначальному виду. Дальше будем вносить изменения с помощью нового модуля.


Результат анализа
*****************

В результате мы определили, что для блока «Мой профиль» используется:

1.  Шаблон ``/design/themes/[название_темы]/templates/blocks/my_account.tpl``

2.  PHP схема ``app/schemas/block_manager/blocks.php`` которая подключает данный шаблон и создаёт новый блок.

Приступим к модификации.


Модификация
===========

Мы будем добавлять новый шаблон для блока «Мой профиль» с помощью модуля «Мои изменения».

«Мои изменения» — стандартный модуль для ваших модификаций и расширений. По умолчанию данный модуль не выполняет никаких функций, новые функции можете добавлять вы. 

.. image:: img/new_my_account_08.png
    :alt: Новый блок

Будем делать:

1.  Создадим новый шаблон который будет отображаться на витрине.
2.  Расширим PHP схемы, чтобы у существующего блока «Мой профиль» появился новый шаблон. 
3.  Добавим несколько языковых переменных, чтобы названия шаблона правильно отображались.

Создадим новый шаблон
---------------------

Все шаблоны модулей расположены в папке:

``/design/themes/[название_темы]/templates/addons/[id_модуля]``

.. note:: 

    Как узнать id модуля читайте тут: :doc:`/developer/howto/addon/index`


1.  Пройдите в папку ``/design/themes/[название_темы]/templates/addons/``

    Создайте папку ``my_changes`` , для шаблонов модуля «Мои изменения» (если ещё не создана). 

    Создайте папку ``blocks`` в папке ``my_changes`` , чтобы в итоге получилась структура:

    ``/design/themes/[название_темы]/templates/addons/my_changes/blocks``

2.  Создайте новый файл ``track_orders.tpl`` в только что созданной папке.

    Чтобы получился новый файл расположенный в:

    ``/design/themes/[название_темы]/templates/addons/my_changes/blocks/track_orders.tpl``

3.  Откройте файл и вставьте тестовый код. Полный код вставим позже, когда всё будет работать.

    .. literalinclude:: files/new_my_account_1.tpl
        :linenos:    

Шаблон создан, теперь необходимо создать схему для подключения нового шаблона.

Расширим PHP схему
------------------

Ранее мы выяснили, что нужно расширять схему ``app/schemas/block_manager/blocks.php``

1.  Откройте папку модуля «Мои изменения»:

    ``app/addons/my_changes/``

2.  Нам нужно повторить структуру папок аналогично ``app/schemas/block_manager/``, только ``app`` заменится на путь модуля. 

    Создайте папку:

    ``app/addons/my_changes/schemas/block_manager``

3.  Создайте новый файл ``blocks.post.php``.

    ``app/addons/my_changes/schemas/block_manager/blocks.post.php``

    Делаем вывод о логике и закономерности для расширения любой схемы:

    .. list-table::
        :widths: 10 30

        *   -   Оригинал

            -   ``app/schemas/block_manager/blocks.php``

        *   -   Расширение

            -   ``app/addons/my_changes/schemas/block_manager/blocks.post.php``

    Идём дальше.

4.  Открываем созданный файл и вставляем код для расширения стандартной схемы:

    .. literalinclude:: files/schema_post_1.php
        :linenos:   

    Работаем как с обычными php массивами. 

5.  Проверяем. Для этого используем функцию ``fn_print_r()``.

    .. literalinclude:: files/schema_post_test.php
        :linenos:   

    Перезагружаем страницу "Редактирования макета" в панели администратора. 

    Должны отобразится две схемы, во второй должен быть путь к новому шаблону, который мы добавили.

    .. fancybox:: img/new_my_account_09.png
        :alt: Новый блок

    Убираем отладочные функции ``fn_print_r``. 

6.  Всё схема расширена. 

    Открываем параметры блока «Мой профиль» в панели администратора.

    Смотрим список шаблонов, должен появится наш новый шаблон.

    .. fancybox:: img/new_my_account_10.png
        :alt: Новый блок

    Как видите, сейчас он называется ``my_block_track_orders`` , такое "неправильное" название связано с тем что:

    *   Шаблон новый и нет языковой переменной для названия блока. 

    *   Когда мы создали тестовый шаблон, мы указали::

        {** block-description:my_block_track_orders **}

        именно данная строчка сообщает платформе, какую языковую переменную использовать для шаблона. 

7.  Создадим языковую переменную ``my_block_track_orders`` с помощью модуля «Мои изменения».

    Откройте файл:

    ``app/addons/my_changes/addon.xml``

    Добавим строки, которые создают языковые переменные при установке модуля.

    .. literalinclude:: files/addon.xml
        :linenos:   

    Преустановите и включите модуль «Мои изменения» в панели администратора.

    Опять открываем параметры блока «Мой профиль» в панели администратора.

    Смотрим список шаблонов, должно появится правильное название.

    .. fancybox:: img/new_my_account_11.png
        :alt: Новый блок

    .. note::

        Также, языковую переменную можно просто создать в панели администратора, на странице «Переводы».

8.  Создадим новый блок с новым шаблоном и разместим его в левой колонке.

    Вид блока «Мои профиль», назовём его «Отлеживание заказов» и выберем шаблон «Мой шаблон: Отслеживание заказов»

    .. fancybox:: img/new_my_account_15.png
        :alt: Новый блок

    .. fancybox:: img/new_my_account_13.png
        :alt: Новый блок

    .. fancybox:: img/new_my_account_14.png
        :alt: Новый блок

9.  Проверяем новый блок на витрине.

    .. image:: img/new_my_account_16.png
        :alt: Новый блок

    Всё правильно, отобразился текст который мы добавили в наш новый шаблон. 

Приступаем к редактированию нового шаблона, добавим форму отслеживания.

Добавляем форму отслеживания в новый шаблон
-------------------------------------------

Мы создали схему для нового шаблона и заготовку самого шаблона. Пока там только простой текст. Добавим необходимую форму. 

Форму мы возьмём из стандартного блока «Мой профиль».

1.  Открываем стандартный шаблон блока «Мой профиль».

    ``/design/themes/[название_темы]/templates/blocks/my_account.tpl``

    Находим блок кода отвечающий за отображения формы отслеживания заказа. 

2.  Открываем созданный нами шаблон «Отслеживание заказов».

    ``/design/themes/[название_темы]/templates/addons/my_changes/blocks/track_orders.tpl``

3.  Вставляем код формы, чтобы шаблон получился такого вида:

    .. literalinclude:: files/new_my_account_2.tpl
        :linenos:   

4.  Переходим на витрину и проверям новый блок. 

    .. image:: img/new_my_account_18.png
        :alt: Новый блок

Готово.

Результат
---------

Новый шаблон для блока «Мой профиль», который вы можете использовать в любом месте вашего сайта. 

По аналогии возможно создание новых блоков и расширение существующих блоков. 

Успехов!