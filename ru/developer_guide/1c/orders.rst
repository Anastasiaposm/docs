***********************************
Обмен заказами в формате CommerceML
***********************************

.. contents:: Содержание
    :local: 
    :depth: 3


Процесс обмена
==============

**1. Начало сеанса.**

	 Этап предназначен для авторизации системы учета на сайте. В ответе на запрос с базовой авторизацией, сайт отправляет данные о запущенной сессии.
**2. Запрос параметров**


	 На этом этапе системе учета запрашивает информацию о возможностях сайта:
	
			* Поддержка zip файлов. Статус поддержки zip файлов зависит от наличия расширения Zip в PHP. Расширение является обязательным для работы CS-Cart, поэтому статус поддержки zip будет всегда положительным, однако вы можете явно отключить поддержку zip файлов для CommerceML через файл конфигурации, указав:
			
			  ``$config[‘commerceml’][‘allow_zip’] = false;``
	
			* Максимальный размер файла. Размер высчитывается на основе таких настроек PHP как: `upload_max_filesize` и `post_max_size`. Однако вы можете явно указать меньший размер файла для CommerceML через файл конфигурации, указав:
			
			  ``$config[‘commerceml’][‘file_limit’] = ‘12M’;``

	 Также на этом этапе проходит ротация файлов с предыдущих сеансов обмена данными и подготовка директории для текущего сеанса: ``var/files/<company_id>/exim/1C``, где ``<company_id>`` - идентификатор витрины или вендора в зависимости от редакции CS-Cart.	  

**3. Запрос файла обмена с сайта**

	 Этап предназначен для выгрузки информации о заказах в систему учета.
	 Список выгружаемых заказов зависит от стратегии экспорта заказов. Для формирования XML документа из данных о заказе используется ``\Tygh\Addons\CommerceML\Formators\OrderFormator``.
**4. Выгрузка файлов обмена на сайт**


	 Этап разбит на несколько шагов:

		 1. Распаковка zip архива
	
		 2. Парсинг XML и конвертация
	
			 На этом этапе все необходимые для импорта сущности конвертируются  в DTO и сохраняются в БД, для дальнейшего использования. За процесс конвертации отвечают так называемые конверторы, все конверторы модуля CommerceML расположены в пространстве имен ``Tygh\Addons\CommerceML\Convertors``.
		     В модуле CommerceML выделены следующие типы сущностей:	 
	   
					* ProductDto - Для данных о товаре. 
					* CategoryDto - Для данных о категории.
					* CurrencyDto - Для данных о валюте.
					* PriceTypeDto - Для данных о типе цен.
					* ProductFeatureDto - Для данных о характеристики товара.
					* ProductFeatureVariantDto - Для данных о варианте характеристики товара.
					* TaxDto - Для данных о типе налог.
		
			 Кроме этого модуль реализует множество других DTO, например ``PropertyDto``, который может использоваться для сохранения значения пользовательского свойства товара. Полный список всех DTO вы можете посмотреть в пространстве имен ``Tygh\Addons\CommerceML\Dto``.
	
		 3. Импорт товаров
	
		    Импорт выполняется итерационно с ограничением по времени на одну итерацию - 60 секунд. На этом шаге из БД выбираются товары и все необходимые для импорта товара DTO. За процесс импорта отвечают так называемые импортеры, все импортеры модуля CommerceML расположены в пространстве имен ``Tygh\Addons\CommerceML\Importers``. На процесс импорта влияют большое кол-во настроек синхронизации, процесс импорта может значительно отличаться в зависимости от настроек. Все импортеры стремятся использовать стандартные функции ядра, так например для создания товара будет вызван ``fn_update_product``, это значительно повышает согласованность данных и снимает нагрузку с разработчиков, теперь не нужно дублировать логику с ``fn_update_product`` на ``CommerceML``, однако это влияет на скорость работы импорта в целом.
		    По завершению всего импорта из БД удаляются все DTO.
			
			   .. important:: Важно! Первый импорт как правило происходит в режиме анализа данных, т.е. ничего не импортируется. Это связано с тем, что для полноценного импорта необходимо сопоставить некоторые сущности системы учета с сущностями на сайте, это как минимум: 
				     
						* Типы цен
						* Типы налогов
						* Валюты
	
**5. Загрузка данных**

	 Этап разбит на несколько шагов:
			1. Распаковка zip архива
			2. Парсинг XML и конвертация
			   На этом этапе все необходимые для импорта сущности конвертируются  в DTO и сохраняются в БД, для дальнейшего использования. За процесс конвертации заказа в DTO отвечает конвертор ``OrderConvertor``.
			3. Импорт заказов
			   Импорт выполняется итерационно с ограничением по времени на одну итерацию - 60 секунд. На этом шаге из БД выбираются заказы и все необходимые для импорта заказа DTO. За процесс импорта отвечает импортер ``OrderImporter``, который использует функции ядра, так например для обновления информации о заказе используется функция ``fn_update_order``.
			   
			   .. important:: Важно! Импорт заказов не создает новые заказы, таким образом импорт только обновляет существующие заказы на сайте.
			   
Точки расширения
================

**1. Схема cml/aliases**

	 Смотри описание схемы cml/aliases в разделе точек расширения выгрузки каталога товаров.
**2. Схема cml/callbacks_sales.**

	 Смотри описание схемы cml/callbacks_catalog в разделе точек расширения выгрузки каталога товаров.
**3. Cхема cml/commands (Экспериментальная логика, со временем может изменится)**

	 Смотри описание схемы cml/commands в разделе точек расширения выгрузки каталога товаров.
**4. Хук commerceml_order_formator_form**

	 Выполняется после формирования данных для XML на основе данных о заказе, но до преобразования в XML. Таким образом вы можете расширить или изменить XML документ заказа.
**5. Хук commerceml_order_convertor_convert**

	 Выполняется после конвертации заказа в ``OrderDto``. Позволяет расширить ``OrderDto`` пользовательскими данными.

Запуск обмена в ручном режиме
=============================
Для запуска выгрузки каталога товара в ручном режиме выполните следующие шаги:

1. Создайте директорию ``var/files/<company_id>/exim/1C``, где ``<company_id>`` - идентификатор витрины или вендора в зависимости от редакции CS-Cart.
2. Загрузите в директорию ``var/files/<company_id>/exim/1C`` файлы import.xml и offers.xml полученные из системы учета.
3. Для обработки файла import.xml перейдите в браузере по адресу http://exmpale.com/index.php?dispatch=commerceml.import&type=catalog&mode=import&filename=import.xml&is_manual=1. На запрос базовой авторизации укажите email и пароль администратора витрины либо вендора в зависимости от редакции CS-Cart.
   Результатом запроса могут быть следующие ответы:
	* progress - Означает, что обработка еще не завершена, в этом случае, повторите исходный запрос.
	* success - Означает, что обработка успешна завершена и можно переходить к следующему шагу.
	* failure - Означает, что обработка завершилась ошибкой. Ошибки обработки можно будет увидеть в логах.
4. Для обработки файла offers.xml перейдите в браузере по адресу http://exmpale.com/index.php?dispatch=commerceml.import&type=catalog&mode=import&filename=offers.xml&is_manual=1.
   Результатом запроса могут быть следующие ответы:
	* progress - Означает, что обработка еще не завершена, в этом случае, повторите исходный запрос.
	* success - Означает, что обработка успешна завершена.
	* failure - Означает, что обработка завершилась ошибкой. Ошибки обработки можно будет увидеть в логах.

.. important::

    Важно! Для полноценного выполнения импорта нужно сопоставить сущности системы учета с сущностями сайта в настройках синхронизации в административной панеле, в противном случае каждый запуск обмена будет выполняться только в режиме анализа.

.. important::

	Важно! Отключите дебаггер если он запущен, в противном случае возможен выход за пределы выделенной памяти, т.к. дебаггер будет стремится собрать максимум информации.

Логи и ротация
==============
Детальную информацию о ходе выполнения обмена можно увидеть в файле ``var/files/<company_id>/exim/commerceml.log``, где ``<company_id>`` - идентификатор витрины или вендора в зависимости от редакции CS-Cart.
По умолчанию размер файла ограничен объемом в 10MB. В случае если размер файла превышает указанный объем, файл подвергается ротации, таким образом в директории ``var/files/<company_id>/exim/`` могут образоваться файлы вида ``var/files/<company_id>/exim/commerceml.log.<N>``, где <N> - порядковый номер, чем больше номер, тем старше файл. По умолчанию максимальное кол-во таких файлов равно 10. 

Вы можете изменить значения по умолчанию в файле конфигурации указав:

``$config['commerceml']['max_log_file_size'] = 20480; //20MB``

``$config['commerceml']['max_log_files'] = 100;``

Обратите внимание, параметр ``max_log_file_size`` задается в килобайтах.

Ротации также подвергается директория ``var/files/<company_id>/exim/1С``, таким образом в директории ``var/files/<company_id>/exim/`` могут образоваться директории вида ``var/files/<company_id>/exim/1С.<N>``, где <N> - порядковый номер, чем больше номер, тем старше директория. Ротация этой директории выполняется на этапе “Запрос параметров”.

По умолчанию максимальное кол-во таких директорий равно 20. 

Вы можете изменить значение по умолчанию в файле конфигурации указав:

``$config['commerceml']['max_dirs_count’] = 5;``