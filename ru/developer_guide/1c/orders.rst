***********************************
Обмен заказами в формате CommerceML
***********************************

.. warning::

    Информация в данной статье устарела и может использоваться лишь в ознакомительных целях.

.. contents:: Содержание
    :local: 
    :depth: 3

Процесс обмена заказами между системой учета и CS-Cart осуществляется в два этапа:

*   Система учета выгружает статусы заказов в интернет-магазин.

*   Интернет магазин выгружает данные заказов в систему учета.

Файл заказов выгружается в папку интернет-магазина: 

``ваш_домен/var/files/код_компании/exim/1C_ТекущаяДата``


Процесс обмена
==============

Инициатором обмена между является система учета, при этом выгрузка данных CS-Cart осуществляется с помощью функций модуля “Экспорт и импорт в 1С”:

*   exim_1c.php - обрабатывает запросы системы и вызывает функции из файла func.php.

*   func.php - содержит функции обработки и загрузки данных.

.. note::

    Файлы функций расположены в папке ``ваш_домен/app/addons/rus_exim_1c/``

Старт
-----

Загрузка файлов начинается с того, что система отправляет запрос вида: 

``ваш_домен/exim_1c?type=catalog&mode=checkauth``

В ответ CS-Cart с помощью функции exim_1c.php передает системе учета:
    
*   Слово ``success`` - успех.

*   Имя Cookie.

*   Значение Cookie.

.. note::

    Дальнейшие запросы к интернет магазину со стороны системы учета будут содержать имя и значение Cookie. Обработка файлов происходит последовательно.

Загрузка файла orders.xml
-------------------------

Система учета загружает в интернет-магазин файл ``ordersИдентификаторФайла.xml`` в папку:

``ваш_домен/var/files/код_компании/exim/1C_ТекущаяДата``

Обработка файла заказов системы учета ``ordersИдентификаторФайла.xml``, осуществляется запросом вида: 

``ваш_домен/app/addons/rus_exim_1c/exim_1c.php?type=sale&mode=file&filename=ordersИдентификаторФайла.xml``

Обработка осуществляется с помощью функции ``fn_exim_1c_import_orders`` в файле ``func.php``.

Выгрузка файла orders.xml
-------------------------

Выгрузка заказов из интернет магазина осуществляется запросом вида: 

``ИнтернетМагазин/exim_1c?type=sale&mode=query``

Выгрузка заказов осуществляется пошагово. Модуль интернет-магазина формирует файл с помощью:

1.  Данные заказа - файл exim_1c.php.

2.  Данные покупателя - функция ``fn_exim_1c_build_customer_info`` файла func.php.

3.  Данные товаров - функция ``fn_exim_1c_build_order_products`` файла func.php.

Успех
-----

В случае успешной загрузки данных система учета передает строку со словом "success", в случае конфликта "failure".

После обмена сформированные файлы с данными из системы сохранятся в папке:

``ваш_домен/var/files/код_компании/exim/1C_ТекущаяДата``

.. fancybox:: img/image_014.png
    :alt: Файлы обмена


Пример модификаций
==================

Если в процессе работы с модулем необходимо внести какие-либо изменения или добавить новые функции, то все изменения вносятся в файлы папки ``app/addons/rus_exim_1c/``.

Задача
------

Необходимо настроить выгрузку заказов с указанного номера.

Решение
-------

1.  Откройте файл ``/app/addons/rus_exim_1c/addon.xml``

2.  Добавьте новую настройку

.. literalinclude:: file/addon_order.xml
    :linenos:

3.  Для добавления выгрузки заказов с указанного файла откройте файл ``/app/addons/rus_exim_1c/func.php``

4.  В открывшемся файле найдите функцию ``fn_rus_exim_1c_get_orders`` (функция вызывается в файле exim_1c.php)

.. literalinclude:: file/exim_order.php
    :linenos:

5.  Внесите изменения в функцию ``fn_rus_exim_1c_get_orders``, чтобы она осуществляла запрос заказов с указанного номера.

.. literalinclude:: file/func_order.php
    :linenos:

6.  Для просмотра результатов записи данных в какую-либо переменную используйте функцию ``fn_print_r($query)``. Функция выведет на экран переменную с остановкой работы скрипта. Возможен вывод нескольких переменных одновременно, просто перечислите через запятую ``fn_print_r($a, $b, $array);``

Тестирование
============

Обработку файла ``orders.xml`` можно осуществлять через браузер, с помощью запроса в адресной строке.

Для этого необходимо скопировать файл с заказами в папку интернет-магазина: 

``var/files/код_компании/exim/1С_ТекущаяДата`` 

    ``ТекущаяДата`` - в формате ДДММГГГГ

.. fancybox:: img/image_018.png
    :alt: Файлы обмена

Тестирование загрузки файла ordersИдентификаторФайла.xml
--------------------------------------------------------

Введите в адресной строке:

``ваш_домен/exim_1c?type=sale&mode=file&filename=ordersИдентификаторФайла.xml``

Пример файла: :download:`orders-42a0dc7a-d94f-462a-a20f-0e09261f4c9d.xml <file/orders-42a0dc7a-d94f-462a-a20f-0e09261f4c9d.xml>`

После загрузки всех данных в окне браузера отобразиться слово означающее окончание обработки файла: 
    
*   ``success`` - успех

*   ``failure`` - ошибка

**Пример просмотра значений переменных**

Например, вставьте функцию ``fn_print_r($order_id)`` в функцию ``fn_exim_1c_import_orders``

.. literalinclude:: file/func_print_order.php
    :linenos:

Наберите в браузере:

``ваш_домен/exim_1c?type=sale&mode=file&filename=ordersИдентификаторФайла.xml``

В окне браузера должно появиться значения переменной ``$order_id``.

.. fancybox:: img/image_020.png
    :alt: Файлы обмена

Тестирование выгрузки файла orders.xml
--------------------------------------

Для просмотра файла c заказами, которые будут выгружены из интернет-магазина в систему учета, введите в браузере: 

``ваш_домен/exim_1c?type=sale&mode=query`` 

В браузере отобразятся заказы выгружаемые из интернет-магазина.

.. fancybox:: img/image_021.png
    :alt: Файлы обмена

Результат тестирования
----------------------

После обмена данными, можно посмотреть данные о заказах загруженные в интернет-магазин.

.. fancybox:: img/image_022.png
    :alt: Файлы обмена
	
В случае ошибок
---------------

Смотрите: :ref:`1c-error`



.. toctree::
    :maxdepth: 3
    :glob:
    :hidden:

    ./ordersxml
