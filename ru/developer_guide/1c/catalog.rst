*****************************************************
Выгрузка каталога из системы учета в интернет-магазин
*****************************************************

.. warning::

    Информация в данной статье устарела и может использоваться лишь в ознакомительных целях.

.. contents:: Содержание
    :local: 
    :depth: 3

Процесс обмена
==============

1.  Система учета инициализирует запуск файла ``ваш_домен/app/addons/rus_exim_1c/controllers/frontend/exim_1c.php``.

2.  Система учета формирует и передает файлы с данными о товарах в папку ``ваш_домен/var/files/код_компании/exim/1C_ТекущаяДата`` вашего интернет-магазина.

    Например:

    ``www.site.ru/var/files/код_компании/exim/1С_06062014``

    Система учета выгружает в интернет-магазин файлы:

    .. list-table::
        :header-rows: 1
        :widths: 20 20 30

        *   -   Тип данных

            -   Название файла

            -   Расположение файла

        *   -   Данные товаров

            -   import.xml

            -   ``/var/files/код_компании/exim/1C_ТекущаяДата/import.xml``

        *   -   Цены товаров

            -   offers.xml

            -   ``/var/files/код_компании/exim/1C_ТекущаяДата/offers.xml``

        *   -   Изображения номенклатуры

            -   ``*.jpg``, ``*.jpеg`` , ``*.png``

            -   ``/images/from_1c/``

3.  Система учета отправляет запрос на обработку ``import.xml``. 

    *   Обрабатывается и сохраняется в базу данных основная информация о товарах.

    *   Изображения прикрепляются к товарам и копируются в папку ``/images``.

4.  Система учета запускает обработку ``offers.xml``.

    На данном шаге обновляются:

    *   Цены

    *   Остатки

    *   Характеристики

5.  Финиш!


Идентификация (соответствие) данных между системой учета и CS-Cart производится: 

1.  С помощью тега ``<Ид>`` (в выгружаемом файле) и ``external_id`` (в базе данных CS-Cart). 

    .. note::

        Ид == external_id

2.  По наименованию (при поиске категорий и характеристик в базе данных).


Обработка на стороне интернет-магазина
======================================

Обработку данных на стороне интернет-магазина выполняют файлы модуля "Экспорт и импорт в 1С".

.. list-table::
    :widths: 20 20

    *   -   ``ваш_домен/app/addons/rus_exim_1c/controllers/frontend/exim_1c.php``

        -   обрабатывает запросы от системы учета и подключает функции для обработки

    *   -   ``ваш_домен/app/addons/rus_exim_1c/func.php``

        -   содержит функции обработки и загрузки данных.

Авторизация и загрузка файлов
-----------------------------

Загрузка файлов ``import.xml`` и ``offers.xml`` начинается с того, что система учета отправляет запрос:

``ваш_домен/exim_1c?type=catalog&mode=checkauth``

Параметры ``type`` и ``mode`` определяют какой код будет выполнен.

Выполняется авторизация и интернет-магазин передает системе:
    
*   ``success`` - означающая успешность соединения.

*   Имя Cookie.

*   Значение Cookie.

.. note::

    Дальнейшие запросы к интернет-магазину со стороны системы учета будут содержать имя и значение Cookie. Обработка файлов происходит последовательно.

Обработка import.xml
--------------------

Система учета отправляет в интернет-магазин запрос, для начала обработки ``import.xml``:

``ваш_домен/exim_1c?type=catalog&mode=import&filename=import.xml``

Выполняется пошаговая загрузка данных:

*   Категорий - функция ``fn_exim_1c_import_categories``

*   Свойства товара - функция ``fn_exim_1c_import_features``

*   Товары - функция ``fn_exim_1c_import_products``


Обработка offers.xml
--------------------

После обработки файла ``import.xml``, осуществляется обработка файла ``offers.xml``, по запросу со стороны системы учета:

``ваш_домен/exim_1c?type=catalog&mode=import&filename=offers.xml``

Обработка данных из файла ``offers.xml`` производится с помощью функции ``fn_exim_1c_import_offers`` файла func.php.

Результат
---------

В случае успешной загрузки данных система учета передает строку со словом ``success``. Если что то пошло не так, то система передаст ``failure``.

.. _1c-error:

Если возникла ошибка
--------------------

*   Проверьте правильность ввода логина и пароля.

*   Проверьте содержит ли папка ``ваш_домен/var/files/код_компании/exim/1С_ТекущаяДата`` файлы ``import.xml`` и ``offers.xml``.

*   Проверьте имя папки ``1С_ТекущаяДата``. 

    ``ТекущаяДата`` должна соответствовать текущей дате.

*   Проверьте права у папки ``ваш_домен/var/files/код_компании/exim/1С_ТекущаяДата``.

*   Попробуйте очистить файлы cookie.

*   Проверьте права группы администратора в магазине, данные которого указаны в настройках системы учета.

*   Проверьте что модуль "Экспорт и импорт в 1С" включен.

Описание ошибки передается в журнал выгрузки системы учета.

После обмена сформированные файлы с данными из системы учета сохранятся в папке: ``ваш_домен/var/files/код_компании/exim/1С_ТекущаяДата``

.. fancybox:: img/image_001.png
    :alt: Файлы обмена 1С

.. note::

    Примеры файлов можно скачать по ссылкам:

    :download:`import.xml <file/import.xml>`

    :download:`offers.xml <file/offers.xml>`


Пример модификации
==================

Если в процессе работы с модулем необходимо внести какие-либо изменения или добавить новые функции, то все изменения вносятся в файлы папки ``/app/addons/rus_exim_1c/``.

Задача
------

Добавить настройку, которая позволит выбрать параметр из файла ``import.xml``. Параметр будет добавлен в поле товара "Название страницы".

Варианты настройки:

*   Не импортировать - означает, что при загрузке файлов в поле "Название страницы" данные записываться не будут.

*   Наименование - означает, что при загрузке файлов в поле "Название страницы" будет записываться данные файла import.xml тега ``<Наименование>``.

*   Полное наименование - означает, что при загрузке файлов в поле "Название страницы" будет записываться данные файла import.xml тега ``<Описание>``.

Решение
-------

1.  Откройте файл ``/app/addons/rus_exim_1c/addon.xml``.

2.  В открывшийся файл добавьте код настройки, позволяющая выбрать значение записываемое в поле товара "Название страницы".

    .. literalinclude:: file/addon.xml
        :linenos:
		
    .. fancybox:: img/image_023.png
        :alt: Файлы обмена 1С

3.  Для записи значения в поле товара "Название страницы" откройте файл ``/app/addons/rus_exim_1c/func.php``.

4.  Найдите функцию ``fn_exim_1c_import_products`` в файле ``func.php`` (функция fn_exim_1c_import загрузки данных товара вызывается из файла exim_1c.php).

    .. literalinclude:: file/exim_product.php
        :linenos:

5.  Найдите цикл перебора товаров и добавьте код для записи значения в поле товара "Название страницы", в зависимости от выбранной настройки "Использовать в названии страницы (SEO)" модуля "Экспорт и импорт в 1С".

    .. literalinclude:: file/func_product.php
        :linenos:

6.  Для просмотра значений переменных и массивов используйте функцию fn_print_r($array). Функция выведет в браузер значения переменных и массивов в удобном виде. В функцию можно передавать несколько переменных и массивов через запятую.

    .. note::
        
        Обращение к тегам осуществляется через переменную $xml->$cml['ИмяТега']. Список имен тегов находиться в файле ваш_домен/app/addons/rus_exim_1c/schemas/cml_fields/fields_names.php
        Например, $xml->$cml['products'] - обращение к тегу Товар.

    .. literalinclude:: file/import_product.xml
        :linenos:


Тестирование и разработка без системы учета
===========================================

Запуск обработки файлов ``import.xml``, ``offers.xml`` можно осуществлять через браузер с помощью запроса в адресной строке. 

Тем самым вы можете выполнять модификации и разработку без использования систем учета.

Загрузите файлы ``import.xml`` и ``offers.xml`` в папку интернет-магазина: 

``/var/files/код_компании/exim/1С_ТекущаяДата`` 

``ТекущаяДата`` - формате ДДММГГГГ.

.. note::

    Примеры файлов можно скачать по ссылкам:

    :download:`import.xml <file/import.xml>`

    :download:`offers.xml <file/offers.xml>`


.. fancybox:: img/image_006.png
    :alt: Файлы обмена 1С

Тестирование файла import.xml
-----------------------------

Для тестирование файла ``import.xml`` в адресной строке браузера введите:
``ваш_домен/exim_1c?type=catalog&mode=import&filename=import.xml`` 

.. fancybox:: img/image_007.png
    :alt: Файлы обмена 1С

Появиться окно авторизации в котором необходимо ввести имя пользователя интернет-магазина с правами администратора и его пароль.

.. fancybox:: img/image_008.png
    :alt: Файлы обмена 1С

После загрузки всех данных в окне браузера отобразиться слово означающее окончание обработки файла: 

*   ``success`` - означает успешное окончание обработки файла.

*   ``failure`` - означает, что в процессе загрузки файла произошла ошибка.

.. fancybox:: img/image_009.png
    :alt: Файлы обмена 1С

Для просмотра значения какой-либо переменной используйте функцию ``fn_print_r()``.

Например, добавьте fn_print_r($_product) в функцию fn_exim_1c_import_products.

.. literalinclude:: file/func_print_product.php
    :linenos:

Зайдите в браузер и наберите:
``ваш_домен/exim_1c?type=catalog&mode=import&filename=import.xml``

В окне браузера должно появиться значения переменной ``$_product``.

.. fancybox:: img/image_011.png
    :alt: Файлы обмена 1С

Тестирование файла offers.xml
-----------------------------

Для загрузки и обработки файла ``offers.xml`` введите в браузере:
``ваш_домен/exim_1c?type=catalog&mode=import&filename=offers.xml``

После загрузки всех данных в окне браузера отобразиться слово означающее окончание обработки файла: 

*   ``success`` - успех.

*   ``failure`` - ошибка.

Результат тестирования
----------------------

После обмена данными, можно посмотреть данные загруженные в интернет магазин: 

*   Данные категорий - "Меню Товары - Категории".

.. fancybox:: img/image_012.png
    :alt: Файлы обмена 1С

*   Данные о товарах и их ценах - "Меню Товары - Товары".

.. fancybox:: img/image_013.png
    :alt: Файлы обмена 1С

.. note::

    Загрузка файлов должна производиться последовательно. Запустите ``import.xml``, после окончания обработки, запустите ``offers.xml``.

В случае ошибок
---------------

Смотрите: :ref:`1c-error`



.. toctree::
    :maxdepth: 3
    :glob:
    :hidden:

    ./catalogxml
